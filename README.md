

# nanomap_ros

nanomap_ros acts as an interface to allow systems and agents using ROS1 and ROS2 to utilize the NanoMap Library to accelerate occupancy mapping. 

## Disclaimer

This package is currently in beta and under active development. 

The package is provided by the author “AS IS.” WITHOUT WARRANTY OF ANY KIND, EXPRESS, IMPLIED, IN FACT OR ARISING BY OPERATION OF LAW, INCLUDING, WITHOUT LIMITATION, THE IMPLIED WARRANTY OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, NON-INFRINGEMENT AND DATA ACCURACY.

This document is currently under construction and is subject to change at any time.

## Dependencies
The main dependencies are the same as NanoMap. ROS specific dependencies can be found in CMakeLists.txt

## Currently Tested ROS distributions

  * Galactic
  * Noetic (ROS1 Code to be uploaded shortly)
  * Melodic (ROS1 Code to be uploaded shortly)
  
## Installation 
Make sure you have built or installed the required dependencies, and place the package in the src folder of your ROS workspace. Currently the CMakeLists.txt uses hardcoded paths to most dependencies, so edit the CMakeLists.txt file to point to the locations where they are built/installed.

Assuming you have also acquired [nanomap_msgs](https://github.com/ViWalkerDev/nanomap_msgs), simply run `colcon build' from your workspace to build the package.

## Usage
nanomap_ros provides 3 different executables. 

### Simulation
The joySim, and poseSim simulation nodes provide the capacity to use an existing VDB grid (that can be generated by the caveGen methods in the NanoMap library) and sensor models to simulate the view of an agent and build an occupancy map. 

joySim subscribes to /cmd_vel to control the pose of the agent via a joystick

poseSim subscribes to a user provided topic containing a geometry_msgs/PoseStamped message type. This pose is used to move the agent through the environment. 
   
### Server
The server node provides server capabilities. It subscribes to to a sensor topic, and a pose topic and creates an occupancy map. 

## Configuration
Configuration files are used to control NanoMap functionality. Each sensor needs to be defined by their own sensor.txt file. Agent definitions define sensor position relative to the agents. The main configuration file defines the operational parameters.

### Main Configuration
The following settings are available in the main config file
  * MappingRes: The resolution of the map to be constructed in metres.
  * ProbHitThres: This should nearly always be 0.5, sets the minimum probabilistic threshold to activate a voxel.
  * ProbMissThres: Again, this should be 0.5, this sets the probabilistic threshold to deactive a voxel. 
  * GridRes: This is the resolution of the simulation grid if it is being used. 
  * Node Edge: This should be 8, this only needs to be changed if using non-standard OpenVDB grid configurations.
  * FrustumAllocationFactor: 0.4 is normally an okay value. This determines the initial amount of GPU memory allocated for the frustum sensing based arrays.
  * FilterType: 0 or 1. 0 disables the voxelisation filter, 1 enables it. 
  * UpdateType: 0 performs Map Updates at the voxel level, 1 performs Map Updates in parallel at the node level using TBB. updateType 1 is not guaranteed to outperform updateType 0. 
  * PrecisionType: 0, 1, 2, 3. This changes the precision type of the voxel filter (if FilterType == 1). 
      * Precision 0 uses the most memory but is the most accurate.
      * Precision 1 uses 1/2 the memory of Precision 0, has similar accuracy and is faster. However this feature requires CUDA Arch > 6.x.
      * Precision 2 uses 1/4 of the memory of Precision 0, has worse accuracy but is also faster than Precision 1. 
      * Precision 3 uses 1/16 of the memory of Precision 0, has the same accuracy as Precision 2, but is less performant in most cases. Useful for extremely memory limited systems that still benefit from input filtering. (Such as the Jetson Nano). 
  * PublishSensor: Only useful for publishing the sensor point clouds generated during simulation. 
  * SimGrid: The absolute path to the simulation openvdb grid, only necessary for simulation capabilities
  * Sensor: Absolute Path to the sensor configuration file for the sensor being used. Repeat this for all unique sensors in use.
  * Agent: Absolute Path to the agent configuration file.

### Sensor Configuration
The following settings are used by the Sensor Config File, sensors can be defined as laser or frustum. For Frustum Sensors the settings used are:
  * Name: PlainText name identifier used for sensor lookup during operation 
  * Id: Alternative form of lookup using integer
  * HRes: Horizontal resolution of the sensor
  * VRes: Vertical resolution of the sensor
  * VFOV: Vertical field of view in degrees
  * Rate: Not currently used.
  * MaxRange: Max usable range for inputs
  * MinRange: Minimum usable range for inputs
  * ProbHit: Probabilistic Value for Sensor Hit (default 0.95)
  * ProbMiss: Probabilist Value for Sensor Miss (default 0.35)
  * FrameTransform: Defines the rotation matrix that rotates sensor frame to world frame. Default (0.0 -1.0 0.0 0.0 0.0 1.0 1.0 0.0 0.0)

For Laser Sensors the settings used are:
  * Name: PlainText name identifier used for sensor lookup during operation 
  * Id: Alternative form of lookup using integer
  * AngularHRes: Horizontal resolution of the sensor
  * AngularVRes: Vertical resolution of the sensor
  * HFOV: Horizontal field of view in degrees
  * VFOV: Vertical field of view in degrees
  * Rate: Not currently used.
  * MaxRange: Max usable range for inputs
  * MinRange: Minimum usable range for inputs
  * ProbHit: Probabilistic Value for Sensor Hit (default 0.95)
  * ProbMiss: Probabilist Value for Sensor Miss (default 0.35)
  * FrameTransform: Defines the rotation matrix that rotates sensor frame to world frame. 
### Agent Configuration
The following settings are used by the Agent Config File. The settings used are:
  * Spawn:
     * Type: fixed vs random
     * Position: If fixed, position defines the XYZ position of the agent within the world frame in metres.
     * Orientation: If fixed, orientation defines the agent orientation as a quaternion.
  * Observations: These settings define the observations used by an agent for deep-rl tasks, this is not completely implemented.
     * NumObs: Number of observation rays
     * LenObs: Length of the observation rays
     * CollisionDist: Minimum length an observation ray can be before the agent is considered to have collided with the simulation environment.
   * Sensor: Defines one sensor that the agent uses, duplicate for when using more than one sensor
      * Name: Plaintext name of the sensor, must match the name in the sensor.txt config file.
      * Position: Position of the sensor relative to the centre of the agent.
      * Orientation: Orientation of the sensor relative to the orientation of the agent.  

## Other ROS Packages

[nanomap_benchmark](https://github.com/ViWalkerDev/nanomap_benchmark) is another package used for benchmarking the performance of NanoMap and its different modes of operation against Octomap.

[nanomap_msgs](https://github.com/ViWalkerDev/nanomap_msgs) is a msg package that is used by nanomap_ros for sending openvdb grid objects between nodes.

[nanomap_rviz2_plugins](https://github.com/ViWalkerDev/nanomap_rviz2_plugins) is an rviz2 plugin for rendering the openvdb grid messages defined by nanomap_msgs and sent by nanomap_ros.
